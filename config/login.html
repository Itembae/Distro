<!DOCTYPE html>
<html>
<head>
  <title>DOE caMicroscope</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./apps/landing/main.css" />
  <script type="text/javascript" src="./common/util.js"></script>
</head>
<body>
  <header id="header">
    <label style="color:white;padding:0 15px;font-size:20px;position:relative;">CaMicroscope<a target="_blank" style="position:absolute;right:2vw;" href="https://docs.google.com/forms/d/e/1FAIpQLScL91LxrpAZjU88GBZP9gmcdgdf8__uNUwhws2lzU6Lr4qNwA/viewform">Feedback</a></label>
    <nav id="nav">
        <ul>
            <!-- <li><a target="_blank" href="https://docs.google.com/forms/d/e/1FAIpQLScL91LxrpAZjU88GBZP9gmcdgdf8__uNUwhws2lzU6Lr4qNwA/viewform">Feedback</a></li> -->
            <!-- <li><a href="./login.html?logout=true">Sign Out</a></li> -->
        </ul>
    </nav>
  </header>
  <section id="main" class="wrapper" style="padding:3em;">
    <div class="inner">
      <header class="major">
        <h2 style="margin:0;">DOE caMicroscope</h2>
      </header>
      <!-- Content -->

      <div class="content">
        <p>DOE <strong>caMicroscope</strong> is a tool to view, label, and annotate biomedical images.</p>
        <a href="#" class="image fit"><img src="./apps/landing/banner1.jpg" alt="" /></a>

      </div>

      <div class="posts" style="justify-content: center;">
        <!-- Organizer -->
        <section class="post">
          <a href="#" class="image"><img src="./apps/landing/camic.jpg" alt=""/></a>
            <div class="content">
                <h3 id="login_txt">Please sign in or out.</h3>
                <button id="sign_in" class="btn-primary">Sign In</button>
                <button id="sign_out" class="btn-warning">Sign Out</button>
            </div>
        </section>
      </div>
  </section>
 <style>
   .hidden{
     display: none;
   }
   </style>
  <script>
    function logOut(){
      deleteCookie("token");
      console.log("logging out");
    }

    function logIn() {
      // relative url for login using the header inserted before backend.
      var logInUrl = "./auth/Token/header";
      fetch(logInUrl).then(x=>x.json()).then(x=>{
        console.log(x);
        var cookie_name = "token"; // "token" is the expected cookie name
        var base_deployment_url = window.location
          .toString()
          .split("/")
          .slice(0, -1)
          .join("/");
        var redirect_uri = base_deployment_url + "/login.html";
        var default_redirect = base_deployment_url + "/apps/table.html";
        var state;
        if (getUrlParam("state")) {
          state = decodeURIComponent(getUrlParam("state"));
        }
        if (!state) {
          state = default_redirect;
        }
        document.cookie = cookie_name + "=" + x.token;
        let token_data = parseJwt(x.token);
      }).catch(err=>{
        console.error(err);
      });
    }

    function deleteCookie(selected) {
      var allcookies = document.cookie.split(";");
      for (var i = 0; i < allcookies.length; i++) {
        var cookie = allcookies[i];
        var eqPos = cookie.indexOf("=");
        var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
        if (name==selected){
          document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;";
        }
      }
    }

  function checkLoginStatus(){
    if(getCookie("token")){
      // we're logged in; set text
      document.getElementById("login_txt").innerText="You are currently logged in";
      // show logout button
      document.getElementById("sign_out").classList.remove("hidden");
      // hide login button
      document.getElementById("sign_in").classList.add("hidden");
    } else {
      // we're logged out; set text
      document.getElementById("login_txt").innerText="You are currently logged out";
      // show login button
      document.getElementById("sign_in").classList.remove("hidden");
      // hide logout button
      document.getElementById("sign_out").classList.add("hidden");
    }
  }

  window.onload = checkLoginStatus
  document.getElementById("sign_out").onclick = logOut;
  document.getElementById("sign_in").onclick = logIn;

  </script>
</body>
</html>
